<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stalls List</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .stall-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: transform 0.2s ease-in-out;
        }

        .stall-card:hover {
            transform: translateY(-5px);
        }

        .stall-card h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.8em;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .stall-card p {
            color: #555;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .stall-card p strong {
            color: #333;
        }

        .stall-card img {
            max-width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .stall-card .details-btn {
            background-color: #007bff;
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            align-self: flex-start;
            transition: background-color 0.2s;
        }

        .stall-card .details-btn:hover {
            background-color: #0056b3;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
            padding: 15px 0;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .pagination button {
            background-color: #007bff;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            transition: background-color 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .pagination button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .pagination span {
            font-size: 1em;
            color: #333;
            font-weight: 500;
        }

        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            align-items: center;
        }

        .filter-section input[type="text"],
        .filter-section select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            flex: 1;
            min-width: 150px;
        }

        .filter-section .btn {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }

        .filter-section .btn:hover {
            background-color: #218838;
        }

        .no-stalls-message {
            text-align: center;
            font-size: 1.2em;
            color: #777;
            padding: 40px;
            border: 1px dashed #ccc;
            border-radius: 8px;
            margin-top: 30px;
        }

        .owner-tag {
            font-size: 0.8em;
            font-weight: 500;
            color: #28a745;
            margin-left: 8px;
            background-color: #e6ffe6;
            padding: 3px 8px;
            border-radius: 4px;
            vertical-align: middle;
        }
    </style>
</head>
<body class="bg-stalls">
    <div class="main-container">
        <h1>Stalls List</h1>
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
            <button id="addStallBtn" class="btn-primary">âž• Add Stall</button>
            <button id="logoutBtn" class="btn-secondary" style="background-color: #f39c12; border-color: #f39c12;">ðŸšª Logout</button>
        </div>

        <div class="filter-section">
            <input type="text" id="searchName" placeholder="Search by name" />
            <input type="text" id="searchCity" placeholder="Search by city" />
            <select id="filterCategory">
                <option value="">All Categories</option>
                <option value="Indian">Indian</option>
                <option value="Chinese">Chinese</option>
                <option value="Italian">Italian</option>
                <option value="Mexican">Mexican</option>
                <option value="Desserts">Desserts</option>
                <option value="Beverages">Beverages</option>
                <option value="Fast Food">Fast Food</option>
                <option value="South Indian">South Indian</option>
                <option value="North Indian">North Indian</option>
                <option value="Street Food">Street Food</option>
                <option value="Bakery">Bakery</option>
                <option value="CafÃ©">CafÃ©</option>
            </select>
            <select id="stallsPerPage">
                <option value="5">5 Stalls per page</option>
                <option value="10">10 Stalls per page</option>
                <option value="15">15 Stalls per page</option>
                <option value="20">20 Stalls per page</option>
            </select>
            <button id="applyFiltersBtn" class="btn">Apply Filters</button>
        </div>

        <div id="stallsList">
            <p class="loading-message">Loading stalls...</p>
        </div>

        <div class="pagination">
            <button id="prevPageBtn" disabled>Previous</button>
            <span id="currentPageSpan">Page 1</span>
            <button id="nextPageBtn">Next</button>
        </div>
    </div>

    <script>
        const stallsList = document.getElementById("stallsList");
        const prevPageBtn = document.getElementById("prevPageBtn");
        const nextPageBtn = document.getElementById("nextPageBtn");
        const currentPageSpan = document.getElementById("currentPageSpan");
        const addStallBtn = document.getElementById("addStallBtn");
        const logoutBtn = document.getElementById("logoutBtn");

        const searchNameInput = document.getElementById("searchName");
        const searchCityInput = document.getElementById("searchCity");
        const filterCategorySelect = document.getElementById("filterCategory");
        const applyFiltersBtn = document.getElementById("applyFiltersBtn");
        const stallsPerPageSelect = document.getElementById("stallsPerPage");

        let currentPage = 1;

        const token = localStorage.getItem("token");
        const BASE_API_URL = "https://localbites-2.onrender.com";

        if (token) {
            addStallBtn.style.display = "inline-block";
            logoutBtn.style.display = "inline-block";
        } else {
            addStallBtn.style.display = "none";
            logoutBtn.style.display = "none";
        }

        addStallBtn.addEventListener("click", () => {
            window.location.href = "/add-stall";
        });

        logoutBtn.addEventListener("click", () => {
            localStorage.removeItem("token");
            alert("You have been logged out.");
            window.location.href = "/login";
        });

        async function fetchStalls() {
            stallsList.innerHTML = "<p class='loading-message'>Loading stalls...</p>";
            prevPageBtn.disabled = true;
            nextPageBtn.disabled = true;

            const name = searchNameInput.value;
            const city = searchCityInput.value;
            const category = filterCategorySelect.value;
            const limit = stallsPerPageSelect.value;

            let query = `page=${currentPage}&limit=${limit}`;
            if (name) query += `&name=${encodeURIComponent(name)}`;
            if (city) query += `&city=${encodeURIComponent(city)}`;
            if (category) query += `&foodCategory=${encodeURIComponent(category)}`;

            try {
                const res = await fetch(`${BASE_API_URL}/api/stalls?${query}`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                renderStalls(data.stalls);
                updatePagination(data.pagination);
            } catch (error) {
                console.error("Error fetching stalls:", error);
                stallsList.innerHTML = "<p class='no-stalls-message'>Failed to load stalls. Please try again later.</p>";
            }
        }

        function renderStalls(stalls) {
            stallsList.innerHTML = "";
            if (stalls.length === 0) {
                stallsList.innerHTML = "<p class='no-stalls-message'>No stalls found matching your criteria.</p>";
                return;
            }

            stalls.forEach((stall) => {
                const stallCard = document.createElement("div");
                stallCard.classList.add("stall-card");

                const isPostedByOwner = stall.postedBy && stall.postedBy.role === "owner";
                const ownerTag = isPostedByOwner ? `<span class="owner-tag">Posted by Owner</span>` : '';

                stallCard.innerHTML = `
                    <img src="${stall.imageUrl || 'https://via.placeholder.com/400x200?text=No+Image'}" alt="${stall.name}">
                    <h2>${stall.name} ${ownerTag}</h2> <p><strong>Owner:</strong> ${stall.ownerName}</p>
                    <p><strong>Location:</strong> ${stall.city}, ${stall.area}</p>
                    <p><strong>Category:</strong> ${stall.foodCategory}</p>
                    <p><strong>Food Item:</strong> ${stall.foodItem}</p>
                    <p><strong>Accepts GPay:</strong> ${stall.acceptsGpay ? "Yes" : "No"}</p>
                    <button class="details-btn" data-id="${stall._id}">View Details</button>
                `;
                stallsList.appendChild(stallCard);
            });

            document.querySelectorAll(".details-btn").forEach((button) => {
                button.addEventListener("click", (e) => {
                    const stallId = e.target.dataset.id;
                    window.location.href = `/stall-details?id=${stallId}`;
                });
            });
        }

        function updatePagination(pagination) {
            const { total, page, limit, totalPages } = pagination;
            currentPageSpan.textContent = `Page ${page} of ${totalPages}`;
            prevPageBtn.disabled = page === 1;
            nextPageBtn.disabled = page === totalPages;
        }

        prevPageBtn.addEventListener("click", () => {
            if (currentPage > 1) {
                currentPage--;
                fetchStalls();
            }
        });

        nextPageBtn.addEventListener("click", () => {
            currentPage++;
            fetchStalls();
        });

        applyFiltersBtn.addEventListener("click", () => {
            currentPage = 1;
            fetchStalls();
        });

        stallsPerPageSelect.addEventListener("change", () => {
            currentPage = 1;
            fetchStalls();
        });

        fetchStalls();
    </script>
</body>
</html>
